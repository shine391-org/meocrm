# MeoCRM - Agent Operations Manual

**Consolidated guide for AI agents (Claude/Jules) working on MeoCRM project**

---

## Quick Navigation

| Section | For When |
|---------|----------|
| [1. Onboarding](#1-onboarding) | First time setup |
| [2. Daily Workflow](#2-daily-workflow-option-3-claude-solo) | Starting a task |
| [3. Testing](#3-testing) | Writing/running tests |
| [4. Service-Specific](#4-service-specific-context) | Backend or Frontend work |
| [5. 10 Development Lessons](#5-development-lessons-checklist) | Before every commit |

---

## 1. Onboarding

### Initial Setup
```bash
./setup-jules-vm.sh

# Copy environment files
cp apps/api/.env.example apps/api/.env
cp apps/web/.env.local.example apps/web/.env.local
```

### Essential Reading (Load in Order)
| Priority | File | Purpose | Size |
|----------|------|---------|------|
| ðŸ”´ 1 | [WORKFLOW-SIMPLE.md](WORKFLOW-SIMPLE.md) | Daily workflow | 5 min |
| ðŸ”´ 2 | [ROADMAP.md](ROADMAP.md) | Current tasks (91/187 complete) | 10 min |
| ðŸŸ¡ 3 | [DEVELOPMENT_LESSONS_LEARNED.md](DEVELOPMENT_LESSONS_LEARNED.md) | 10 coding rules | 5 min |
| ðŸŸ¡ 4 | [docs/essential/01_BUSINESS_LOGIC.md](docs/essential/01_BUSINESS_LOGIC.md) | Business rules | 15 min |
| ðŸŸ¢ 5 | [docs/essential/ENVIRONMENT.md](docs/essential/ENVIRONMENT.md) | Ports, DB, Redis | 5 min |

**Total onboarding:** ~40 minutes

---

## 2. Daily Workflow (Option 3: Claude Solo)

### Principle: "Claude Builds, Jules Validates"

```
Phase 1: PLAN (You + Claude)
    â†“
Phase 2-4: CLAUDE SOLO
    - Implement
    - Test
    - Document
    - Push to feature branch
    â†“
Phase 5: JULES CI/CD
    - Auto-checkout branch
    - Run tests in VM
    - Report results
    â†“
Phase 6: MERGE (You)
    - Review PR + Jules report
    - Merge if green
```

### Phase 1: PLAN (5-15 min)

**You provide:**
```
Task: [Feature name from ROADMAP.md]
Context: [ROADMAP line reference, Business Logic section]
Priority: [High/Medium/Low]
```

**Claude loads context:**
1. ROADMAP.md task details
2. Relevant docs (Business Logic, API Reference)
3. DEVELOPMENT_LESSONS_LEARNED.md
4. Similar existing code patterns

**Handoff:** Claude confirms understanding â†’ proceed

---

### Phase 2-4: CLAUDE SOLO (1-8h depending on complexity)

#### Step 1: Create Branch
```bash
git checkout -b feature/TASK-NAME
```

#### Step 2: Implement Code

**Context loading strategy:**
- Simple CRUD: ~80 KB (WORKFLOW + ROADMAP + similar code)
- Medium module: ~170 KB (+ Business Logic + Schema)
- Complex feature: ~300 KB (+ Integration + Testing guides)

**Pre-coding checklist (DEVELOPMENT_LESSONS_LEARNED.md):**
- [ ] **Lesson #1:** Response format `{ data: T }` or `{ data: T[], meta }`
- [ ] **Lesson #2:** URL prefix `/api` (global prefix set)
- [ ] **Lesson #3:** Error format `{code, message, traceId}`
- [ ] **Lesson #6:** OrganizationGuard on all endpoints
- [ ] **Lesson #7:** Soft delete with `deletedAt`
- [ ] **Lesson #9:** No hardcoded values (use Settings)
- [ ] **Lesson #10:** Consistent patterns

#### Step 3: Write Tests

**Coverage target:** â‰¥80%

**Test structure:**
```typescript
describe('ModuleName', () => {
  // Happy path
  it('should work with valid data', async () => {
    const result = await service.create(dto, orgId);
    expect(result.data).toHaveProperty('id');
  });

  // Error cases
  it('should throw when organizationId missing', async () => {
    await expect(service.create(dto, null)).rejects.toThrow();
  });

  // Multi-tenant isolation
  it('should not access other org data', async () => {
    const result = await service.findAll(otherOrgId);
    expect(result.data).toHaveLength(0);
  });
});
```

**Run tests:**
```bash
# API tests
pnpm --filter @meocrm/api test

# Web tests
pnpm --filter @meocrm/web test

# All tests
pnpm -w test
```

#### Step 4: Update Docs

In same commit:
- [ ] ROADMAP.md - Mark task completed
- [ ] docs/reference/04_API_REFERENCE.md - Add endpoints (if new)
- [ ] CHANGELOG.md - Add entry under [Unreleased]

#### Step 5: Commit & Push

**Commit message format:**
```bash
git commit -m "feat(module): description

- Detail 1
- Detail 2
- Follow DEVELOPMENT_LESSONS_LEARNED.md

Implements: TASK-ID
Related: ROADMAP.md lines X-Y

ðŸ¤– Generated by Claude Code"
```

```bash
git push origin feature/TASK-NAME
```

#### Step 6: Create PR

```bash
gh pr create \
  --title "feat(module): description (TASK-ID)" \
  --base dev \
  --body "$(cat <<'EOF'
## Summary
[Brief description]

## Changes
- **Component/Service** (X lines)
  - Feature 1
  - Feature 2

## DEVELOPMENT_LESSONS_LEARNED.md Compliance
- [x] Lesson #1: Response format
- [x] Lesson #6: OrganizationGuard
- [x] Lesson #9: No hardcoded values

## Documentation Updates
- [x] ROADMAP.md updated
- [x] API_REFERENCE.md updated (if applicable)

## Testing
Local tests:
```
âœ… module.service.spec.ts (X tests passed)
```

**âš ï¸ Awaiting Jules CI/CD validation**

## Related
- Implements: TASK-ID from ROADMAP.md
- Blocks: [other tasks]

ðŸ¤– Generated by Claude Code
EOF
)" \
  --label "needs-vm-validation"
```

---

### Phase 5: JULES CI/CD (15-45 min)

**Trigger:** You tell Jules "Test PR #123"

**Jules runs:**
```bash
cd /path/to/meocrm
bash jules-ci.sh 123
```

**Jules posts to PR:**
- âœ…/âŒ Build status
- âœ…/âŒ Test results
- Coverage report
- Approval/Changes requested

**If tests fail:**
- Claude reviews errors
- Claude fixes in new commit
- Jules re-runs validation

---

### Phase 6: MERGE (You)

**Prerequisites:**
- âœ… PR created by Claude
- âœ… Jules CI/CD green
- âœ… Code review done

**Actions:**
1. Review PR on GitHub
2. Verify ROADMAP.md updated
3. Click "Merge pull request"
4. Delete branch

**Post-merge:**
```bash
git checkout dev
git pull origin dev
git branch -d feature/TASK-NAME
```

---

## 3. Testing

### Test Commands

```bash
# API service
pnpm --filter @meocrm/api test

# Web service
pnpm --filter @meocrm/web test

# All tests
pnpm -w test

# With coverage
pnpm -w test --coverage

# E2E tests
pnpm test:e2e
```

### Testing Requirements

**Coverage target:** â‰¥80% (CI fails if lower)

**Test pyramid:**
- Unit tests: 70%
- Integration tests: 20%
- E2E tests: 10%

**Critical test scenarios:**
- âœ… Happy path
- âœ… Error cases (validation, auth, etc.)
- âœ… Multi-tenant isolation
- âœ… Soft delete behavior

**Golden E2E flow:**
```
Login â†’ Create Product â†’ Create POS Order â†’ Verify Stock Decreased
```

See [docs/guides/testing/Strategy-&-Coverage.md](docs/guides/testing/Strategy-&-Coverage.md) for details.

---

## 4. Service-Specific Context

### 4.1 Backend (@meocrm/api)

**Framework:** NestJS

**Key Rules:**
- **Multi-tenant security:** ALL database queries MUST filter by `organizationId`
- **PrismaService:** Use for all database access
- **OrganizationGuard:** Apply to all controllers (Lesson #6)

**Architecture:**
```
Controller (HTTP layer)
    â†“
Service (Business logic)
    â†“
PrismaService (Database)
```

**Testing:**
```bash
pnpm --filter @meocrm/api test
```

**Key docs:**
- [docs/reference/04_API_REFERENCE.md](docs/reference/04_API_REFERENCE.md)
- [docs/essential/03_DATABASE_SCHEMA.md](docs/essential/03_DATABASE_SCHEMA.md)
- [docs/essential/01_BUSINESS_LOGIC.md](docs/essential/01_BUSINESS_LOGIC.md)

---

### 4.2 Frontend (@meocrm/web)

**Framework:** Next.js (App Router)

**Key Rules:**
- **UI Components:** Use shadcn/ui components from `components/ui`
- **State Management:** React Query for server state
- **API Communication:** Functions in `lib/api/`
- **Server Actions:** Use for mutations (Lesson #8)
- **No client redirects:** Server-side only (Lesson #4)

**Architecture:**
```
Page (App Router)
    â†“
Server Actions (Mutations)
    â†“
API Client (lib/api/)
    â†“
Backend API
```

**Testing:**
```bash
pnpm --filter @meocrm/web test
```

**Key docs:**
- [docs/reference/04_API_REFERENCE.md](docs/reference/04_API_REFERENCE.md) (API endpoints)

---

## 5. Development Lessons Checklist

**Use before EVERY commit:**

### Code Quality
- [ ] **#1:** Response format `{ data: T }` or `{ data: T[], meta }`
- [ ] **#2:** URL prefix `/api` (global prefix set)
- [ ] **#3:** Error format `{code, message, traceId}`
- [ ] **#4:** No Next.js client redirects (server-side only)
- [ ] **#5:** Use Prisma generated types
- [ ] **#6:** OrganizationGuard on all endpoints
- [ ] **#7:** Soft delete with `deletedAt`
- [ ] **#8:** Server actions for Next.js mutations
- [ ] **#9:** No hardcoded values (use Settings)
- [ ] **#10:** Consistent patterns across modules

### Testing
- [ ] Unit tests written
- [ ] Integration tests written
- [ ] Coverage â‰¥80%
- [ ] Multi-tenant isolation tested

### Documentation
- [ ] ROADMAP.md updated
- [ ] API_REFERENCE.md updated (if new endpoints)
- [ ] CHANGELOG.md updated

### Git
- [ ] Commit message follows format
- [ ] Branch name descriptive
- [ ] PR description detailed

**If ANY checkbox unchecked â†’ DO NOT PUSH**

See [DEVELOPMENT_LESSONS_LEARNED.md](DEVELOPMENT_LESSONS_LEARNED.md) for full details.

---

## 6. Settings & Configuration

**Core principle:** No hardcoded values (Lesson #9)

**All settings-driven:**
- Lead Priority rules
- Commission calculations
- Refund policies
- Shipping calculations
- Notification preferences

**Where to configure:**
- Settings console (Admin UI)
- Seed config: [docs/guides/settings/README.md](docs/guides/settings/README.md)

**In code:**
```typescript
// âŒ Bad - hardcoded
const refundDeadline = 7; // days

// âœ… Good - settings-driven
const refundDeadline = await settingsService.get('refund.deadline', orgId);
```

---

## 7. Multi-Tenant Security

**Critical rule:** Every database query MUST filter by `organizationId`

### Backend (NestJS)

**Prisma middleware auto-injects:**
```typescript
// Automatically filtered by organizationId
const products = await prisma.product.findMany();
```

**Raw SQL must manually filter:**
```sql
SELECT * FROM products
WHERE organization_id = $1  -- REQUIRED
```

**OrganizationGuard:**
```typescript
@UseGuards(OrganizationGuard)
@Controller('products')
export class ProductsController {
  // All endpoints automatically have organizationId
}
```

### Frontend (Next.js)

**Server actions auto-inject organizationId:**
```typescript
export async function createProduct(data: ProductDto) {
  // organizationId from session
  return api.post('/api/products', data);
}
```

---

## 8. Error Handling

**Standard error format (Lesson #3):**
```typescript
{
  code: 'PRODUCT_NOT_FOUND',
  message: 'Product not found',
  traceId: 'abc-123-def',
  details?: { ... }  // optional
}
```

**OpenAPI schema:** `components.schemas.Error`

---

## 9. Time Estimates

| Task Complexity | Phase 1 (Plan) | Phase 2-4 (Claude) | Phase 5 (Jules) | Total |
|----------------|---------------|-------------------|----------------|-------|
| **Simple** (CRUD single entity) | 5-10 min | 1-1.5h | 15-20 min | **1.5-2h** |
| **Medium** (Full module + relations) | 10-15 min | 3-4h | 20-30 min | **3.5-5h** |
| **Complex** (Multi-module + logic) | 15-20 min | 6-8h | 30-45 min | **7-9h** |

**Daily throughput (8h):**
- Simple: 3-4 tasks/day
- Medium: 1-2 tasks/day
- Complex: 1 task/day

---

## 10. Troubleshooting

See [docs/reference/06_TROUBLESHOOTING.md](docs/reference/06_TROUBLESHOOTING.md) for:
- Environment issues
- Docker/Postgres/Redis errors
- Test failures
- Build errors

---

## 11. Quick Commands

```bash
# Development
pnpm --filter @meocrm/api dev     # Backend (port 2003)
pnpm --filter @meocrm/web dev     # Frontend (port 2004)

# Database
pnpm --filter @meocrm/api prisma:generate  # Generate Prisma client
pnpm --filter @meocrm/api prisma:migrate   # Run migrations
pnpm --filter @meocrm/api prisma:reset     # Reset DB (local only)

# Testing
pnpm --filter @meocrm/api test    # API tests
pnpm --filter @meocrm/web test    # Web tests
pnpm -w test                      # All tests
pnpm test:e2e                     # E2E tests

# Build
pnpm build                        # Build all packages

# Git workflow
git checkout -b feature/task-name
git add .
git commit -m "feat: description"
git push origin feature/task-name
gh pr create
```

---

## 12. Success Metrics

Track weekly:
- Tasks completed: 15-20/week
- First-time-right rate: â‰¥90%
- Average task time: <3h (simple), <5h (medium)
- Rework iterations: â‰¤1 per task
- Test coverage: â‰¥80%
- Conflicts: 0

---

## Related Files

- **Daily workflow:** [WORKFLOW-SIMPLE.md](WORKFLOW-SIMPLE.md)
- **Task tracking:** [ROADMAP.md](ROADMAP.md)
- **10 coding rules:** [DEVELOPMENT_LESSONS_LEARNED.md](DEVELOPMENT_LESSONS_LEARNED.md)
- **Business logic:** [docs/essential/01_BUSINESS_LOGIC.md](docs/essential/01_BUSINESS_LOGIC.md)
- **Database schema:** [docs/essential/03_DATABASE_SCHEMA.md](docs/essential/03_DATABASE_SCHEMA.md)
- **API reference:** [docs/reference/04_API_REFERENCE.md](docs/reference/04_API_REFERENCE.md)
- **Testing guide:** [docs/guides/testing/Strategy-&-Coverage.md](docs/guides/testing/Strategy-&-Coverage.md)
