generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
  CASHIER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  E_WALLET
  BANK_TRANSFER
  COD
}

enum ShippingStatus {
  PENDING
  PICKING_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  RETURNED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branches        Branch[]
  users           User[]
  categories      Category[]
  products        Product[]
  customers       Customer[]
  suppliers       Supplier[]
  orders          Order[]
  shippingOrders  ShippingOrder[]
  productVariants ProductVariant[]

  @@map("organizations")
}

model Branch {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  code           String
  address        String
  phone          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization @relation(fields: [organizationId], references: [id])
  inventory     Inventory[]
  transfersFrom Transfer[]   @relation("FromBranch")
  transfersTo   Transfer[]   @relation("ToBranch")

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("branches")
}

model User {
  id             String   @id @default(cuid())
  organizationId String
  email          String   @unique
  password       String
  name           String
  role           UserRole @default(STAFF)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id])
  orders        Order[]
  refreshTokens RefreshToken[]

  @@index([organizationId])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Category {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  parentId       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  parent       Category?    @relation("CategoryTree", fields: [parentId], references: [id])
  children     Category[]   @relation("CategoryTree")
  products     Product[]

  @@index([organizationId])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id             String    @id @default(cuid())
  organizationId String
  sku            String
  name           String
  description    String?
  categoryId     String?
  costPrice      Decimal   @db.Decimal(12, 2)
  sellPrice      Decimal   @db.Decimal(12, 2)
  stock          Int       @default(0)
  minStock       Int       @default(0)
  maxStock       Int       @default(999999)
  images         String[]
  weight         Int?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? @map("deleted_at")

  organization Organization     @relation(fields: [organizationId], references: [id])
  category     Category?        @relation(fields: [categoryId], references: [id])
  variants     ProductVariant[]
  orderItems   OrderItem[]
  inventory    Inventory[]

  @@unique([sku, organizationId])
  @@index([organizationId])
  @@index([categoryId])
  @@index([sku])
  @@map("products")
}

model ProductVariant {
  id             String   @id @default(cuid())
  productId      String
  sku            String
  name           String
  sellPrice      Decimal  @default(0) @db.Decimal(12, 2)
  stock          Int      @default(0)
  images         String[]
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id])
  OrderItem    OrderItem[]

  @@unique([sku, organizationId])
  @@index([productId])
  @@map("product_variants")
}

model Customer {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  name           String
  phone          String
  email          String?
  address        String?
  province       String?
  district       String?
  ward           String?
  segment        String?
  totalSpent     Decimal      @default(0) @db.Decimal(12, 2)
  totalOrders    Int          @default(0)
  debt           Decimal      @default(0) @db.Decimal(12, 2)
  lastOrderAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?    @map("deleted_at")
  organization   Organization @relation(fields: [organizationId], references: [id])
  orders         Order[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([phone])
  @@map("customers")
}

model Supplier {
  id             String    @id @default(cuid())
  organizationId String
  code           String
  name           String
  phone          String
  email          String?
  address        String?
  taxCode        String?
  totalPurchased Decimal   @default(0) @db.Decimal(15, 2)
  totalOrders    Int       @default(0)
  debt           Decimal   @default(0) @db.Decimal(15, 2)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime? @map("deleted_at")

  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([code, organizationId])
  @@index([organizationId])
  @@map("suppliers")
}

model Order {
  id             String        @id @default(cuid())
  organizationId String
  code           String
  customerId     String?
  subtotal       Decimal       @db.Decimal(12, 2)
  discount       Decimal       @default(0) @db.Decimal(12, 2)
  total          Decimal       @db.Decimal(12, 2)
  tax            Decimal       @default(0) @db.Decimal(12, 2)
  shipping       Decimal       @default(0) @db.Decimal(12, 2)
  paymentMethod  PaymentMethod
  isPaid         Boolean       @default(false)
  paidAmount     Decimal       @default(0) @db.Decimal(12, 2)
  status         OrderStatus   @default(PENDING)
  createdBy      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id])
  customer       Customer?       @relation(fields: [customerId], references: [id])
  creator        User?           @relation(fields: [createdBy], references: [id])
  items          OrderItem[]
  shippingOrders ShippingOrder[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([customerId])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  lineTotal Decimal @db.Decimal(12, 2)

  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingOrder {
  id                String         @id @default(cuid())
  organizationId    String
  orderId           String
  trackingCode      String         @unique
  recipientName     String
  recipientPhone    String
  recipientAddress  String
  recipientWard     String?
  recipientDistrict String?
  recipientProvince String?
  shippingFee       Decimal        @db.Decimal(12, 2)
  codAmount         Decimal        @default(0) @db.Decimal(12, 2)
  status            ShippingStatus @default(PENDING)
  weight            Int?
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  order        Order        @relation(fields: [orderId], references: [id])

  @@index([organizationId])
  @@index([orderId])
  @@map("shipping_orders")
}

model Inventory {
  id        String @id @default(cuid())
  productId String
  branchId  String
  quantity  Int    @default(0)

  product Product @relation(fields: [productId], references: [id])
  branch  Branch  @relation(fields: [branchId], references: [id])

  @@unique([productId, branchId])
  @@index([branchId])
  @@map("inventory")
}

model InventoryTransaction {
  id        String   @id @default(cuid())
  type      String
  quantity  Int
  note      String?
  createdAt DateTime @default(now())

  @@map("inventory_transactions")
}

model Transfer {
  id            String         @id @default(cuid())
  code          String         @unique
  fromBranchId  String
  toBranchId    String
  value         Decimal        @db.Decimal(12, 2)
  status        TransferStatus @default(PENDING)
  transferredAt DateTime?
  receivedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  fromBranch Branch @relation("FromBranch", fields: [fromBranchId], references: [id])
  toBranch   Branch @relation("ToBranch", fields: [toBranchId], references: [id])

  @@index([fromBranchId])
  @@index([toBranchId])
  @@map("transfers")
}
