# Cập nhật 18/11/2025

- **Customers & Orders**: Bảo đảm tất cả API khách hàng và đơn hàng đều hoạt động trong bối cảnh đa tenant bằng `OrganizationGuard`/`OrganizationId`, dùng `CustomerStatsService` làm trung tâm để cập nhật thống kê/debt (cả khi tạo, hủy và thay đổi trạng thái đơn). Tests liên quan đã chạy (`customers.service.spec.ts`, `orders.service.spec.ts`).
- **Suppliers**: Controller/service tuân thủ multi-tenant, soft delete + kiểm tra trùng phone/tax, thêm helper `recordPurchase` cho tổng mua/nợ, kèm test mở rộng và gắn tag `OrganizationGuard`.
- **Shipping Module (SHIP-001 → SHIP-011)**: Xây shipping order CRUD (kèm fee calc, partner stats, partner debt, COD, failure/return handling) cộng `ShippingFeeService`, đồng bộ trạng thái với đơn hàng và partner debt updates; đã viết tests `shipping.service.spec.ts` + `shipping-fee.service.spec.ts`.
- **Webhooks**: Tách suite webhooks khỏi lệnh `pnpm test`, mock axios/retry để không block toàn bộ suite (`test:webhooks-unit` + `test:webhooks-int` scripts), bật `WEBHOOK_DISABLE_RETRY` khi cần, và cập nhật integration spec (vẫn chạy riêng).
- **Shipping E2E + Test Harness**: Bổ sung `shipping-flow.int.spec.ts` mô phỏng luồng tạo vận đơn → cập nhật trạng thái → tất toán COD + isolation đa tenant, đồng thời tắt hoàn toàn cron/scheduler/Redis thực trong môi trường test (mock `ioredis`, flag `DISABLE_SCHEDULER`) để `pnpm --filter @meocrm/api test` chạy trọn vẹn (38 suite, 266 tests).
- **Refunds**: Controller/service giờ buộc `OrganizationGuard` + truyền `organizationId` cho mọi truy vấn `prisma.order`, tránh staff của org khác đọc/ghi dữ liệu refund; tests unit/integration cập nhật tương ứng.
- **Kiểm tra**:
  - `pnpm --filter @meocrm/api test -- shipping.service.spec.ts shipping-fee.service.spec.ts webhooks.service.spec.ts`
  - `pnpm --filter @meocrm/api test:webhooks-unit`
  - `pnpm --filter @meocrm/api test:webhooks-int`
  - `pnpm --filter @meocrm/api test`
